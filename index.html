<!DOCTYPE html>
<html>
  <head>
    <title>BrewPublik &mdash; Routific to Tookan Converter</title>
    <style>
      html {
        font-size: 16px;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background-color: #9B95ED;
        color: #FFF;
        font-family: Arial;
        line-height: 1.5;
      }
      .container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }
      .convert {
        text-align: center;
      }
      .convert__inputLabel {
        background-color: #FFF;
        color: #9B95ED;
        padding: 1em 2em;
        border-radius: 1.5em;
        letter-spacing: 0.03rem;
        cursor: pointer;
        font-size: 1rem;
        -webkit-font-smoothing: antialiased;
        font-weight: bold;
      }
      .convert__input {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- BEGIN VISIBLE MARKUP -->
    <div class="container">
      <div class="convert" data-convert>
        <label for="convert-input" class="convert__inputLabel">
          <span>Choose Routific CSV File</span>
          <input type="file" accept="text/csv" class="convert__input" id="convert-input" data-convert-input />
        </label>
      </div>
    </div>
    <!-- END VISIBLE MARKUP -->

    <!-- BEGIN SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.js"></script>
    <script>
      /*
       * Doing this old-school so it can all be in one file
       * and have no overhead for anyone looking to use or
       * extend this.
       */
      ;(function() {
        'use strict'

        /*
         * Hardcoded for now. These are the delivery people
         * who are exported as "Driver Name" from Routific
         * but imported into Tookan as "Agent ID (Settings > Agent)".
         */
        var agents = {
          'Alvin Khambay': 7415,
          'Andrew': 10116,
          'Austin Pope': 7403,
          'Austin Reed': 9293,
          'Brandon': 7588,
          'Cameron Williams': 7528,
          'Danny Noel': 7639,
          'David': 7396,
          'David Whitley': 7674,
          'Ethan Mulligan': 9469,
          'Jason Busick': 11139,
          'Jay Gregus': 10630,
          'Jed Balb': 7401,
          'Jeff Harris': 7528,
          'Josiah Balbuena': 8069,
          'Katie V': 7411,
          'Ian': 7659,
          'Matt Hellman': 8700,
          'Peter Hillick': 7638,
          'Philip Barker': 7409,
          'Ryan O\'Daniel': 7400,
          'Sean Balkwill': 7640,
          'Thomas Perniciario': 7818,
          'Tyler': 8744,
          'Will Taylor': 7402
        }

        // Select input and listen for file to be added
        var input = document.querySelector('[data-convert-input]')
        input.addEventListener('change', handleFile)

        // Read the file and attach load & error events
        function handleFile(e) {
          var file = e.target.files[0]
          var reader = new FileReader()
          reader.readAsText(file, 'UTF-8')
          reader.addEventListener('load', handleReadFile)
          reader.addEventListener('error', handleReadFileError)
        }

        // Try to parse the file
        function handleReadFile(e) {
          var result = e.target.result
          if (typeof Papa !== 'undefined') {
            Papa.parse(result, {
              header: true,
              dynamicTyping: true,
              complete: handleParse,
              error: handleParseError
            })
          } else {
            alert('Parser library (PapaParse) not loaded.')
          }
        }

        /*
         * When file is parsed, convert to a Tookan object,
         * convert it back to a CSV and save it
         */
        function handleParse(results) {
          var tookanObjects = results.data.reduce(createTookanObject, [])
          var tookanCSV = Papa.unparse(tookanObjects)
          resetInput()
          download(tookanCSV)
        }

        // Receive CSV data and reformat appropriately for Tookan
        function createTookanObject(array, data) {
          if (!!data['shipment id']) {
            var [street, city, state, zip] = data['Address'].split(' , ')
            var currentDate = getFormattedDate(new Date())
            array.push({
              'Task Description'                            : data['Notes 2'],
              'Customer Email'                              : data['email'],
              'Customer Name'                               : data['Visit Name'],
              'Street level address*'                       : street,
              'City'                                        : city,
              'Zipcode / Pincode*'                          : zip,
              'Country*'                                     : 'United States',
              'Customer Phone'                              : data['Phone'],
              'Start Date and Time (MM-DD-YYYY) (HH:MM:SS)*': currentDate + ' ' + data['Time window start'],
              'End Date and Time (MM-DD-YYYY) (HH:MM:SS)*'  : currentDate + ' ' + data['Time window end'],
              'Agent ID (Settings > Agent)'                 : agents[data['Driver Name']],
              'Team_ID(or leave this column empty)'         : '3113',
              'Template_ID'                                 : 'Beer Deliveries',
              'Shipment ID'                                 : data['shipment id']
            })
          }
          return array
        }

        function getFormattedDate(date) {
          var month = date.getMonth() + 1
          var day = date.getDate()
          var year = date.getFullYear()
          return [month, day, year].join('/')
        }

        // Trigger browser download for FF, IE11 and Chrome.
        // Safari will redirect to a page that can be Save As...
        function download(csv) {
          var timestamp = (new Date).toISOString()
          var filename = timestamp + '-brewpublik-routific-to-tookan.csv'
          var csvData = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
          var csvURL = navigator.msSaveBlob ? navigator.msSaveBlob(csvData, filename) : window.URL.createObjectURL(csvData)
          var downloadLink = document.createElement('a')
          downloadLink.href = csvURL
          downloadLink.setAttribute('download', filename)
          downloadLink.click()
        }

        function resetInput() {
          var input = document.querySelector('[data-convert-input]')
          input.value = null
        }

        // Handle file read error
        function handleReadFileError(e) {
          alert('There was an error reading the file.')
        }

        // Handle file parse error
        function handleParseError(e) {
          alert('There was an error parsing the file.')
        }
      })();
    </script>
    <!-- END SCRIPTS -->
  </body>
</html>
